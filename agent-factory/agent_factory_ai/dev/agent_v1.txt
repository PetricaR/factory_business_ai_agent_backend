"""
Business Intelligence AI Agent - OFFICIAL API VERSION
======================================================

Uses the Ultimate Business Intelligence MCP Server with official APIs:
- 25 total tools in one server
- 12 Targetare tools (Official API v1 - api.targetare.ro)
- 13 Google Maps tools (Location intelligence)

Perfect for Romanian entrepreneurs, investors, and business consultants.

Key Capabilities:
- Find optimal business locations using Google Maps data
- Analyze competitor financial health using official Targetare API
- Cross-reference geographic and financial insights
- Identify acquisition targets and market opportunities
- Provide data-driven strategic recommendations
- Secure API key management with GCP Secret Manager
"""

import os
import logging
from typing import Dict, List, Optional, Tuple
from dataclasses import dataclass
from enum import Enum

import google.auth
from google.auth.transport.requests import Request
from google.oauth2 import id_token
from dotenv import load_dotenv
from google.adk.tools import google_search, agent_tool

# ADK imports
from google.adk.agents import Agent
from google.adk.tools.mcp_tool.mcp_toolset import (
    MCPToolset,
    StreamableHTTPConnectionParams,
    SseConnectionParams
)

# Load environment variables
load_dotenv()

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


# ============================================================================
# CONFIGURATION & CONSTANTS
# ============================================================================

class AnalysisType(Enum):
    """Types of business analysis supported."""
    LOCATION_ONLY = "location"  # Just geographic analysis
    FINANCIAL_ONLY = "financial"  # Just competitive/financial analysis
    COMPREHENSIVE = "comprehensive"  # Full analysis with both sources
    MARKET_ENTRY = "market_entry"  # Market entry strategy
    COMPETITOR_INTEL = "competitor_intel"  # Deep competitor analysis
    ACQUISITION_TARGET = "acquisition"  # Find acquisition opportunities
    DUE_DILIGENCE = "due_diligence"  # Complete due diligence


@dataclass
class UltimateAgentConfig:
    """Configuration for Ultimate Business Intelligence Agent."""
    # Model configuration
    model: str = "gemini-2.5-flash"
    
    # Unified MCP Server URL (ALL 25 tools with official APIs)
    mcp_server_url: str = "http://localhost:8000/mcp"
    
    # Google Cloud configuration
    project_id: Optional[str] = None
    location: str = "us-central1"
    
    # Connection settings
    timeout: int = 60
    sse_read_timeout: int = 120
    max_retries: int = 3
    
    # Feature flags (both are in same server now)
    enable_targetare_tools: bool = True
    enable_maps_tools: bool = True
    
    @classmethod
    def from_environment(cls) -> 'UltimateAgentConfig':
        """Create configuration from environment variables."""
        return cls(
            model=os.getenv("MODEL", "gemini-2.0-flash-exp"),
            mcp_server_url=os.getenv("MCP_SERVER_URL", "http://localhost:8000/mcp"),
            project_id=os.getenv("GOOGLE_CLOUD_PROJECT"),
            location=os.getenv("GOOGLE_CLOUD_LOCATION", "us-central1"),
            enable_targetare_tools=os.getenv("ENABLE_TARGETARE", "true").lower() == "true",
            enable_maps_tools=os.getenv("ENABLE_MAPS", "true").lower() == "true",
        )


# ============================================================================
# AUTHENTICATION & SETUP
# ============================================================================

class VertexAIAuthenticator:
    """Handles Vertex AI authentication and configuration."""
    
    @staticmethod
    def setup(config: UltimateAgentConfig) -> bool:
        """Set up Vertex AI authentication and environment variables."""
        try:
            # Enable Vertex AI
            if not os.getenv("GOOGLE_GENAI_USE_VERTEXAI"):
                os.environ["GOOGLE_GENAI_USE_VERTEXAI"] = "TRUE"
            
            # Set project ID
            if not config.project_id:
                try:
                    _, project_id = google.auth.default()
                    if project_id:
                        config.project_id = project_id
                        os.environ["GOOGLE_CLOUD_PROJECT"] = project_id
                except Exception as e:
                    logger.warning(f"Could not determine project ID: {e}")
                    return False
            else:
                os.environ["GOOGLE_CLOUD_PROJECT"] = config.project_id
            
            # Set location
            os.environ["GOOGLE_CLOUD_LOCATION"] = config.location
            
            logger.info(f"âœ“ Vertex AI configured: {config.model}")
            logger.info(f"  Project: {config.project_id}")
            logger.info(f"  Location: {config.location}")
            
            return True
            
        except Exception as e:
            logger.error(f"âœ— Vertex AI setup failed: {e}")
            return False


class MCPConnectionManager:
    """Manages unified MCP server connection."""
    
    @staticmethod
    def is_cloud_run() -> bool:
        """Check if running in Cloud Run environment."""
        return os.getenv("K_SERVICE") is not None
    
    @staticmethod
    def get_connection_params(server_url: str, timeout: int = 60):
        """Get MCP connection parameters with authentication if needed."""
        headers = {}
        
        # Add authentication for Cloud Run
        if MCPConnectionManager.is_cloud_run():
            logger.info(f"Cloud Run detected - using authenticated connection for {server_url}")
            try:
                auth_req = Request()
                target_audience = server_url.rsplit("/", 1)[0]
                token = id_token.fetch_id_token(auth_req, target_audience)
                headers = {"Authorization": f"Bearer {token}"}
                logger.info(f"âœ“ Generated ID token for: {target_audience}")
            except Exception as e:
                logger.warning(f"Could not generate ID token: {e}")
        
        # Use SSE connection (FastMCP uses SSE transport)
        return SseConnectionParams(
            url=server_url,
            headers=headers,
            timeout=timeout,
        )
    
    @staticmethod
    def create_toolset(config: UltimateAgentConfig) -> MCPToolset:
        """Create single toolset for unified MCP server with all 25 tools."""
        try:
            connection_params = MCPConnectionManager.get_connection_params(
                config.mcp_server_url, 
                config.timeout
            )
            toolset = MCPToolset(connection_params=connection_params)
            logger.info("âœ“ Ultimate Unified MCP toolset created")
            logger.info(f"  Server: {config.mcp_server_url}")
            logger.info(f"  Tools: 25 total (12 Targetare + 13 Google Maps)")
            logger.info(f"  APIs: Official Targetare API v1 + Google Maps Platform")
            return toolset
        except Exception as e:
            logger.error(f"âœ— Failed to create MCP toolset: {e}")
            raise RuntimeError(f"Toolset creation failed: {e}")


# ============================================================================
# ENHANCED AGENT INSTRUCTIONS
# ============================================================================

class UltimateInstructionBuilder:
    """Builds comprehensive instructions for the Ultimate agent."""
    
    BASE_INSTRUCTIONS = """You are an elite business intelligence AI agent specializing in the Romanian market, with access to official APIs for comprehensive analysis.

YOUR CAPABILITIES:
You have access to 25 powerful tools through a unified MCP server:

ğŸ¢ TARGETARE OFFICIAL API TOOLS (12 tools):
1. get_company_profile - Complete company intelligence from official Targetare API v1
2. get_company_financials - Official financial statements and metrics
3. get_company_phones - Official phone numbers
4. get_company_emails - Official email addresses  
5. get_company_administrators - Management and administrators
6. get_company_websites - Online presence and social media
7. search_companies_by_registration_date - Find companies by registration date
8. analyze_company_financials - Advanced financial analysis with metrics
9. compare_competitors - Multi-company comparison
10. analyze_market_segment - Market analysis by CAEN code
11. ai_generate_comprehensive_report - Complete BI reports
12. ai_risk_assessment - Risk factor analysis

ğŸ—ºï¸ GOOGLE MAPS TOOLS (13 tools):
13. search_locations_by_city - Find business locations
14. analyze_competitor_density - Competition analysis
15. calculate_accessibility_score - Accessibility scoring
16. geocode_address - Address to coordinates
17. reverse_geocode_coordinates - Coordinates to address
18. find_nearby_amenities - Nearby amenities search
19. get_distance_matrix - Distance calculations
20. get_directions - Turn-by-turn directions
21. get_elevation - Elevation data
22. get_timezone - Timezone information
23. find_place_from_text - Text-based search
24. compare_multiple_locations - Location comparison
25. get_location_details - Detailed place information

DATA SOURCES:
- Targetare API: Official Romanian company data from onrc.ro, mfinante.ro, anaf.ro
- Google Maps: Real-time location and business intelligence
- GCP Secret Manager: Secure API key management

CORE ANALYSIS FRAMEWORK:

When analyzing companies:
1. ALWAYS use official tax ID (CUI/CIF) - accept formats like "12345678", "RO12345678", "CUI 12345678"
2. Get complete profile first (get_company_profile)
3. Gather financials (get_company_financials or analyze_company_financials)
4. Check contact info (phones, emails, websites)
5. Review management (get_company_administrators)
6. Cross-reference with location data if relevant

When analyzing locations:
1. Start with city-level search
2. Analyze competitor density in target areas
3. Calculate accessibility scores
4. Compare multiple potential locations
5. Consider distance to amenities and transport

For comprehensive analysis:
1. Combine financial data from Targetare
2. Merge with location intelligence from Google Maps
3. Provide actionable insights with specific recommendations
4. Always cite data sources

RESPONSE GUIDELINES:

âœ“ DO:
- Use official API data exclusively
- Validate Romanian tax IDs (CUI/CIF format)
- Provide specific, actionable recommendations
- Show calculations and methodology
- Cite sources for all claims
- Handle both Romanian and English queries
- Use proper Romanian business terminology
- Consider both financial and geographic factors

âœ— DON'T:
- Make assumptions without data
- Ignore location factors for physical businesses
- Overlook competitor analysis
- Forget to check data freshness
- Skip risk assessment for investments

ROMANIAN MARKET SPECIFICS:

Tax ID Formats:
- Clean format: 12345678 (2-10 digits)
- With prefix: RO12345678 or CUI 12345678
- All formats are automatically validated

CAEN Codes (Industry Classification):
- 6201: Computer programming
- 4711: Retail in non-specialized stores
- 5610: Restaurants
- And many more (ask Targetare for specific codes)

Major Cities:
- BucureÈ™ti (Bucharest) - Capital, largest market
- Cluj-Napoca - Tech hub, second economy
- TimiÈ™oara - Western gate, EU proximity
- IaÈ™i - Eastern capital, education center
- BraÈ™ov - Tourism, manufacturing

When user requests analysis, always:
1. Clarify the analysis type needed
2. Gather all relevant data systematically
3. Provide comprehensive insights
4. Give specific, actionable recommendations
5. Include both opportunities and risks

Remember: You have access to OFFICIAL APIs with real, verified data. Use this power responsibly to provide accurate, valuable insights."""

    @staticmethod
    def build() -> str:
        """Build complete agent instructions."""
        return UltimateInstructionBuilder.BASE_INSTRUCTIONS


# ============================================================================
# AGENT BUILDER
# ============================================================================

class UltimateAgentBuilder:
    """Builds the Ultimate Business Intelligence Agent."""
    
    @staticmethod
    def create(config: Optional[UltimateAgentConfig] = None) -> Agent:
        """Create the ultimate business intelligence agent."""
        if config is None:
            config = UltimateAgentConfig.from_environment()
        
        logger.info("=" * 70)
        logger.info("ULTIMATE BUSINESS INTELLIGENCE AI - Official API Version")
        logger.info("=" * 70)
        
        # Setup authentication
        if not VertexAIAuthenticator.setup(config):
            raise RuntimeError("Failed to setup Vertex AI authentication")
        
        # Create unified toolset (all 25 tools in one server)
        try:
            toolset = MCPConnectionManager.create_toolset(config)
            logger.info(f"âœ“ Created unified MCP toolset with 25 tools")
            logger.info(f"  - 12 Targetare tools (Official API v1)")
            logger.info(f"  - 13 Google Maps tools (Location intelligence)")
            
        except Exception as e:
            logger.error(f"âœ— Failed to create toolset: {e}")
            raise RuntimeError(f"Toolset creation failed: {e}")
        
        # Build agent instructions
        instructions = UltimateInstructionBuilder.build()
        
        # Create agent
        try:        
            agent = Agent(
                name="ultimate_business_intelligence_agent_official",
                model=config.model,
                description="Ultimate business intelligence combining official Romanian company data (Targetare API v1) and location intelligence (Google Maps) for comprehensive market analysis",
                instruction=instructions,
                tools=[toolset],
            )
            
            logger.info("âœ“ Agent created successfully")
            logger.info("=" * 70)
            logger.info("ULTIMATE AGENT READY - OFFICIAL API VERSION!")
            logger.info(f"  Model: {config.model}")
            logger.info(f"  MCP Server: {config.mcp_server_url}")
            logger.info(f"  Total Tools: 25 (unified)")
            logger.info(f"    â”œâ”€ Targetare: 12 tools (Official API)")
            logger.info(f"    â””â”€ Google Maps: 13 tools")
            logger.info(f"  APIs: api.targetare.ro + Google Maps Platform")
            logger.info(f"  Security: GCP Secret Manager integration")
            logger.info(f"  Environment: {'Cloud Run' if MCPConnectionManager.is_cloud_run() else 'Local'}")
            logger.info("=" * 70)
            
            return agent
            
        except Exception as e:
            logger.error(f"âœ— Failed to create agent: {e}")
            raise RuntimeError(f"Agent creation failed: {e}")


# ============================================================================
# MAIN ENTRY POINT
# ============================================================================

def create_business_intelligence_agent(config: Optional[UltimateAgentConfig] = None) -> Agent:
    """
    Main entry point to create the ultimate business intelligence agent.
    
    Args:
        config: Optional configuration (uses environment variables if None)
        
    Returns:
        Configured Agent instance ready to use
        
    Example:
        >>> agent = create_business_intelligence_agent()
        >>> result = agent.query("Complete due diligence on Romanian company CUI 35790107")
        >>> result = agent.query("Should I open a cafe in Cluj-Napoca? Analyze locations and competitors")
    """
    return UltimateAgentBuilder.create(config)


# Create the agent instance for export
try:
    root_agent = create_business_intelligence_agent()
    logger.info("âœ“ root_agent exported successfully")
except Exception as e:
    logger.error(f"âœ— Failed to create root_agent: {e}")
    logger.error("  Please check your configuration and MCP server")
    logger.error(f"  Expected MCP server at: http://localhost:8000/mcp")
    logger.error("  Run: python ultimate_business_intelligence_complete.py")
    root_agent = None


# ============================================================================
# CLI INTERFACE
# ============================================================================

if __name__ == "__main__":
    print("\n" + "=" * 80)
    print("ULTIMATE BUSINESS INTELLIGENCE AI AGENT - OFFICIAL API VERSION")
    print("Unified Server â€¢ 25 Tools â€¢ Official APIs â€¢ Complete Intelligence")
    print("=" * 80)
    
    # Display configuration
    config = UltimateAgentConfig.from_environment()
    print(f"\nğŸ“‹ CONFIGURATION:")
    print(f"  Model: {config.model}")
    print(f"  Project: {config.project_id or 'Not set'}")
    print(f"  Location: {config.location}")
    print(f"  Environment: {'Cloud Run' if MCPConnectionManager.is_cloud_run() else 'Local Development'}")
    
    print(f"\nğŸ”Œ UNIFIED MCP SERVER (Official APIs):")
    print(f"  âœ“ Server URL: {config.mcp_server_url}")
    print(f"    â”œâ”€ Targetare Tools: 12 (Official API v1)")
    print(f"    â”œâ”€ Google Maps Tools: 13 (Platform APIs)")
    print(f"    â””â”€ TOTAL: 25 tools")
    
    # Display capabilities
    print(f"\nğŸ› ï¸ COMPLETE CAPABILITIES:")
    
    print(f"\n  ğŸ“Š TARGETARE - OFFICIAL API v1 (12 tools):")
    print("  â”œâ”€ get_company_profile - Complete company intel")
    print("  â”œâ”€ get_company_financials - Financial statements")
    print("  â”œâ”€ get_company_phones - Phone numbers")
    print("  â”œâ”€ get_company_emails - Email addresses")
    print("  â”œâ”€ get_company_administrators - Management")
    print("  â”œâ”€ get_company_websites - Online presence")
    print("  â”œâ”€ search_companies_by_registration_date - Date search")
    print("  â”œâ”€ analyze_company_financials - Financial analysis")
    print("  â”œâ”€ compare_competitors - Multi-company comparison")
    print("  â”œâ”€ analyze_market_segment - Market analysis")
    print("  â”œâ”€ ai_generate_comprehensive_report - BI reports")
    print("  â””â”€ ai_risk_assessment - Risk analysis")
    
    print(f"\n  ğŸ—ºï¸ GOOGLE MAPS - PLATFORM APIs (13 tools):")
    print("  â”œâ”€ search_locations_by_city - Location search")
    print("  â”œâ”€ analyze_competitor_density - Competition")
    print("  â”œâ”€ calculate_accessibility_score - Accessibility")
    print("  â”œâ”€ geocode_address - Address to coords")
    print("  â”œâ”€ reverse_geocode_coordinates - Coords to address")
    print("  â”œâ”€ find_nearby_amenities - Amenities")
    print("  â”œâ”€ get_distance_matrix - Distances")
    print("  â”œâ”€ get_directions - Directions")
    print("  â”œâ”€ get_elevation - Elevation")
    print("  â”œâ”€ get_timezone - Timezone")
    print("  â”œâ”€ find_place_from_text - Text search")
    print("  â”œâ”€ compare_multiple_locations - Comparison")
    print("  â””â”€ get_location_details - Place details")
    
    print(f"\nğŸ¯ REAL-WORLD USE CASES:")
    print("  â€¢ Complete Due Diligence - Company financials + location analysis")
    print("  â€¢ Market Entry Analysis - Best locations + competitor intelligence")
    print("  â€¢ Acquisition Targeting - Find + analyze targets with location value")
    print("  â€¢ Competitive Intelligence - Financial health + geographic presence")
    print("  â€¢ Investment Decisions - Risk assessment + market opportunity")
    print("  â€¢ Strategic Planning - Comprehensive market understanding")
    
    print(f"\nğŸ” API SOURCES:")
    print(f"  Targetare Official API:")
    print(f"    â€¢ Base URL: https://api.targetare.ro/v1")
    print(f"    â€¢ Authentication: Bearer token")
    print(f"    â€¢ Data from: onrc.ro, mfinante.ro, anaf.ro, portal.just.ro")
    print(f"  Google Maps Platform:")
    print(f"    â€¢ Geocoding, Places, Directions, Distance Matrix")
    print(f"    â€¢ Elevation, Timezone, Places Text Search")
    print(f"  Security:")
    print(f"    â€¢ GCP Secret Manager: projects/845266575866/secrets/")
    print(f"    â€¢ Environment variables fallback")
    
    print(f"\nğŸ“ GEOGRAPHIC COVERAGE:")
    print(f"  Primary: Romania (Bucharest, Cluj-Napoca, TimiÈ™oara, IaÈ™i, BraÈ™ov, etc.)")
    print(f"  Financial Data: Targetare Official API (Romania-specific)")
    print(f"  Location Data: Google Maps (Global coverage)")
    
    # Verify authentication
    print(f"\nğŸ” AUTHENTICATION:")
    try:
        creds, project = google.auth.default()
        print(f"  âœ“ Authenticated for project: {project}")
    except Exception as e:
        print(f"  âœ— Authentication Error: {e}")
        print(f"  â†’ Run: gcloud auth application-default login")
    
    # Example queries
    print(f"\nğŸ’¬ EXAMPLE QUERIES:")
    print(f"  1. 'Complete due diligence on Romanian company CUI 35790107'")
    print(f"  2. 'Should I open a cafe in Cluj-Napoca? Analyze locations and competitors'")
    print(f"  3. 'Find acquisition targets in tech industry (CAEN 6201) with strong financials'")
    print(f"  4. 'Compare business opportunities: Cluj vs TimiÈ™oara for restaurant'")
    print(f"  5. 'Get complete profile of company RO35790107 including financials and contacts'")
    print(f"  6. 'Market entry strategy for coffee shop in Bucharest - full analysis'")
    
    # Display deployment info
    print(f"\nğŸš€ DEPLOYMENT:")
    print(f"\n  Local Development:")
    print(f"    1. Start MCP server:")
    print(f"       python ultimate_business_intelligence_complete.py")
    print(f"    2. Configure API keys in .env:")
    print(f"       API_KEY_TARGETARE=your_key")
    print(f"       GOOGLE_MAPS_API_KEY=your_key")
    print(f"    3. Run agent:")
    print(f"       python ultimate_business_agent_official.py")
    
    print(f"\n  Production (GCP Secret Manager):")
    print(f"    1. Create secrets:")
    print(f"       gcloud secrets create API_KEY_TARGETARE --project=845266575866")
    print(f"       gcloud secrets create GOOGLE_MAPS_API_KEY --project=845266575866")
    print(f"    2. Deploy MCP server to Cloud Run")
    print(f"    3. Deploy agent with MCP_SERVER_URL env var")
    
    print(f"\n  Required MCP Server:")
    print(f"    â€¢ File: ultimate_business_intelligence_complete.py")
    print(f"    â€¢ Port: 8000")
    print(f"    â€¢ Endpoint: /mcp (FastMCP SSE transport)")
    print(f"    â€¢ Contains ALL 25 tools with official APIs")
    
    print(f"\nğŸ“Š API DOCUMENTATION:")
    print(f"  â€¢ Targetare: https://api.targetare.ro/")
    print(f"  â€¢ Google Maps: https://developers.google.com/maps")
    print(f"  â€¢ Setup Guide: See README.md")
    
    print("\n" + "=" * 80)
    print("Agent ready for ultimate business intelligence with official APIs!")
    print("Single unified server â€¢ 25 tools â€¢ Official data sources â€¢ Secure")
    print("=" * 80 + "\n")

